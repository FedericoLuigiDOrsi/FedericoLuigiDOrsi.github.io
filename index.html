<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DirtyTag - Photo QC v7.1</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto Mono', monospace;
            background: #0a0a0a;
            color: #fff;
            min-height: 100vh;
            padding: 15px;
            font-size: 12px;
        }

        .header {
            text-align: center;
            margin-bottom: 15px;
        }

        .header h1 {
            font-size: 1rem;
            color: #fff;
            margin-bottom: 8px;
            font-weight: 400;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .header .version-badge {
            display: inline-block;
            background: #333;
            color: #888;
            padding: 3px 10px;
            font-size: 0.7rem;
            margin-bottom: 8px;
        }

        .header .sku-badge {
            display: inline-block;
            background: #e31e24;
            color: white;
            padding: 6px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            letter-spacing: 2px;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #e31e24;
        }

        .stat-value.batch {
            color: #4CAF50;
        }

        .stat-label {
            font-size: 0.6rem;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .progress-bar {
            width: 100%;
            max-width: 400px;
            height: 4px;
            background: #1a1a1a;
            overflow: hidden;
            margin: 0 auto 12px;
            border-radius: 2px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #e31e24, #ff6b6b);
            transition: width 0.3s;
        }

        .main-container {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .photos-section {
            flex: 1;
            min-width: 0;
        }

        .sidebar {
            width: 260px;
            flex-shrink: 0;
        }

        /* FOTO PI√ô GRANDI: 5-6 per riga */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }

        .photo-card {
            background: #111;
            border: 2px solid #222;
            overflow: hidden;
            transition: all 0.15s;
            cursor: pointer;
            border-radius: 4px;
            position: relative;
        }

        .photo-card:hover {
            border-color: #444;
            transform: scale(1.02);
        }

        .photo-card.selected-front {
            border: 3px solid #e31e24;
            box-shadow: 0 0 15px rgba(227, 30, 36, 0.4);
        }

        .photo-card.selected-back {
            border: 3px solid #fff;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }

        .photo-container {
            position: relative;
            width: 100%;
            padding-top: 100%;
            background: #0a0a0a;
            overflow: hidden;
        }

        .photo-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        /* Rotazione foto */
        .photo-container img.rotate-90 {
            transform: rotate(90deg);
        }
        .photo-container img.rotate-180 {
            transform: rotate(180deg);
        }
        .photo-container img.rotate-270 {
            transform: rotate(270deg);
        }

        .photo-label {
            position: absolute;
            top: 5px;
            left: 5px;
            padding: 3px 8px;
            font-size: 0.65rem;
            font-weight: 700;
            letter-spacing: 1px;
            border-radius: 2px;
            z-index: 10;
        }

        .photo-label.front {
            background: #e31e24;
            color: white;
        }

        .photo-label.back {
            background: #fff;
            color: #000;
        }

        /* Bottone Rotazione */
        .rotate-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 28px;
            height: 28px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #444;
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s, background 0.2s;
            z-index: 20;
        }

        .photo-card:hover .rotate-btn {
            opacity: 1;
        }

        .rotate-btn:hover {
            background: rgba(227, 30, 36, 0.8);
        }

        .photo-filename {
            padding: 8px;
            font-size: 0.65rem;
            color: #666;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background: #0d0d0d;
        }

        /* Sidebar Sections */
        .sidebar-section {
            background: #111;
            border: 1px solid #222;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .sidebar-section h3 {
            font-size: 0.7rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid #222;
        }

        .selection-status {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .selection-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            background: #0a0a0a;
            border-radius: 3px;
        }

        .selection-item.active {
            background: #1a1a1a;
        }

        .selection-item .label {
            font-size: 0.6rem;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .selection-item .status {
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 3px;
        }

        .selection-item .status.selected {
            color: #4CAF50;
        }

        .selection-item .status.pending {
            color: #ff9800;
        }

        /* Flag Buttons */
        .flag-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .flag-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 8px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
            color: #888;
            font-size: 0.65rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .flag-btn:hover {
            background: #252525;
            border-color: #444;
            color: #fff;
        }

        .flag-btn.active {
            background: #2a1a1a;
            border-color: #e31e24;
            color: #e31e24;
        }

        .flag-btn .icon {
            font-size: 1rem;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .action-btn {
            padding: 12px;
            font-family: inherit;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .action-btn.confirm {
            background: #e31e24;
            color: white;
        }

        .action-btn.confirm:hover:not(:disabled) {
            background: #ff3b3b;
        }

        .action-btn.confirm:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }

        .action-btn.skip {
            background: #222;
            color: #888;
            border: 1px solid #333;
        }

        .action-btn.skip:hover {
            background: #2a2a2a;
            color: #fff;
        }

        .action-btn.flag-submit {
            background: #ff9800;
            color: #000;
        }

        .action-btn.flag-submit:hover {
            background: #ffb74d;
        }

        /* Keyboard Hints */
        .keyboard-hints {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .key-hint {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.55rem;
            color: #555;
        }

        .key-hint kbd {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 2px 5px;
            border-radius: 2px;
            font-family: inherit;
            color: #888;
        }

        /* Batch Navigation */
        .batch-nav {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .batch-btn {
            flex: 1;
            padding: 8px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
            color: #888;
            font-family: inherit;
            font-size: 0.65rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .batch-btn:hover:not(:disabled) {
            background: #252525;
            color: #fff;
        }

        .batch-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: #fff;
            font-size: 2rem;
            cursor: pointer;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #222;
            color: #fff;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 0.8rem;
            transition: transform 0.3s;
            z-index: 1001;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            background: #4CAF50;
        }

        .toast.error {
            background: #e31e24;
        }

        .toast.warning {
            background: #ff9800;
            color: #000;
        }

        /* Login Screen */
        .login-screen {
            max-width: 400px;
            margin: 100px auto;
            text-align: center;
        }

        .login-screen h2 {
            font-size: 1rem;
            margin-bottom: 20px;
            font-weight: 400;
            letter-spacing: 3px;
        }

        .login-screen input {
            width: 100%;
            padding: 12px;
            background: #111;
            border: 1px solid #333;
            color: #fff;
            font-family: inherit;
            font-size: 0.8rem;
            margin-bottom: 12px;
            border-radius: 4px;
        }

        .login-screen button {
            width: 100%;
            padding: 12px;
            background: #e31e24;
            border: none;
            color: #fff;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 2px;
            cursor: pointer;
            border-radius: 4px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
            color: #555;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #222;
            border-top-color: #e31e24;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px;
            color: #555;
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        /* AI Mode Badge */
        .ai-mode-badge {
            display: inline-block;
            background: #4CAF50;
            color: #000;
            padding: 4px 10px;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 1px;
            border-radius: 3px;
            margin-top: 8px;
        }

        /* Product Info */
        .product-info {
            font-size: 0.65rem;
            color: #555;
            margin-top: 8px;
        }

        .product-info span {
            color: #888;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-screen">
        <h2>DIRTYTAG PHOTO QC v7.1</h2>
        <input type="password" id="api-token" placeholder="Airtable API Token">
        <button onclick="login()">Accedi</button>
    </div>

    <!-- Main App -->
    <div id="app" style="display: none;">
        <div class="header">
            <h1>PHOTO QC</h1>
            <div class="version-badge">v7.1 ‚Ä¢ BATCH MODE ‚Ä¢ MANI ONLY</div>
            <div class="sku-badge" id="current-sku">---</div>
            <div class="ai-mode-badge">ü§ñ AI MODE: MANI</div>
            <div class="product-info" id="product-info"></div>
        </div>

        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="pending-count">0</div>
                <div class="stat-label">In Coda</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="done-count">0</div>
                <div class="stat-label">Completati</div>
            </div>
            <div class="stat">
                <div class="stat-value batch" id="batch-info">1/1</div>
                <div class="stat-label">Batch (50)</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="batch-progress">0/50</div>
                <div class="stat-label">Nel Batch</div>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>

        <div class="main-container">
            <div class="photos-section">
                <div id="photo-grid" class="photo-grid">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Caricamento foto...
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <!-- Selection Status -->
                <div class="sidebar-section">
                    <h3>Selezione</h3>
                    <div class="selection-status">
                        <div class="selection-item" id="front-status">
                            <div class="label">Front</div>
                            <div class="status pending" id="front-status-text">‚Äî</div>
                        </div>
                        <div class="selection-item" id="back-status">
                            <div class="label">Back</div>
                            <div class="status pending" id="back-status-text">‚Äî</div>
                        </div>
                    </div>
                </div>

                <!-- Flag Buttons -->
                <div class="sidebar-section">
                    <h3>‚ö†Ô∏è Segnalazioni</h3>
                    <div class="flag-grid">
                        <button class="flag-btn" id="flag-missing-front" onclick="toggleFlag('missingFront')">
                            <span class="icon">üì∑</span>
                            <span>No Front</span>
                        </button>
                        <button class="flag-btn" id="flag-missing-back" onclick="toggleFlag('missingBack')">
                            <span class="icon">üì∑</span>
                            <span>No Back</span>
                        </button>
                        <button class="flag-btn" id="flag-reshoot" onclick="toggleFlag('needsReshoot')">
                            <span class="icon">üîÑ</span>
                            <span>Rifare</span>
                        </button>
                        <button class="flag-btn" id="flag-maybe-sold" onclick="toggleFlag('maybeSold')">
                            <span class="icon">üí∞</span>
                            <span>Venduto?</span>
                        </button>
                    </div>
                </div>

                <!-- Actions -->
                <div class="sidebar-section">
                    <h3>Azioni</h3>
                    <div class="action-buttons">
                        <button class="action-btn confirm" id="confirm-btn" onclick="confirmSelection()" disabled>
                            ‚úì Conferma & Prossimo
                        </button>
                        <button class="action-btn flag-submit" id="flag-btn" onclick="submitWithFlags()" style="display: none;">
                            ‚ö†Ô∏è Segnala & Prossimo
                        </button>
                        <button class="action-btn skip" onclick="skipSKU()">
                            ‚è≠Ô∏è Salta SKU
                        </button>
                    </div>

                    <div class="batch-nav">
                        <button class="batch-btn" id="prev-batch-btn" onclick="loadPrevBatch()" disabled>
                            ‚Üê Batch Prec
                        </button>
                        <button class="batch-btn" id="next-batch-btn" onclick="loadNextBatch()" disabled>
                            Batch Succ ‚Üí
                        </button>
                    </div>

                    <div class="keyboard-hints">
                        <span class="key-hint"><kbd>F</kbd> Front</span>
                        <span class="key-hint"><kbd>B</kbd> Back</span>
                        <span class="key-hint"><kbd>R</kbd> Ruota</span>
                        <span class="key-hint"><kbd>1</kbd> No Front</span>
                        <span class="key-hint"><kbd>2</kbd> No Back</span>
                        <span class="key-hint"><kbd>3</kbd> Rifare</span>
                        <span class="key-hint"><kbd>4</kbd> Venduto?</span>
                        <span class="key-hint"><kbd>Enter</kbd> Conferma</span>
                        <span class="key-hint"><kbd>S</kbd> Salta</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal" onclick="closeModal()">
        <button class="modal-close">&times;</button>
        <img id="modal-img" src="" alt="Zoom">
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const BASE_ID = 'apptPbWnDkDkKEpFV';
        const PHOTO_CANDIDATES_TABLE = 'tbl7ogfLnHsVfFdzb';
        const OLD_INVENTORY_TABLE = 'tblddAcLcQAyk050u';
        
        const BATCH_SIZE = 50;
        const AI_MODE = 'MANI';
        const DEFAULT_PLATFORMS = ['Vinted', 'Vestiaire', 'Catawiki'];

        // ============================================
        // STATE
        // ============================================
        let apiToken = '';
        let allRecords = [];
        let currentBatch = [];
        let currentBatchIndex = 0;
        let totalBatches = 0;
        let currentSKU = '';
        let currentPhotos = [];
        let currentSKUIndex = 0;
        let batchSKUs = [];
        
        let selectedFront = null;
        let selectedBack = null;
        let selectedFrontData = null;
        let selectedBackData = null;
        
        // Rotation state per photo (photoId -> rotation degrees)
        let photoRotations = {};
        
        // Last hovered photo for keyboard rotation
        let lastHoveredPhotoId = null;
        
        let flags = {
            missingFront: false,
            missingBack: false,
            needsReshoot: false,
            maybeSold: false
        };
        
        let pendingCount = 0;
        let doneCount = 0;
        let batchDoneCount = 0;

        // ============================================
        // API
        // ============================================
        async function apiRequest(table, options = {}) {
            let url = `https://api.airtable.com/v0/${BASE_ID}/${table}`;
            
            const fetchOptions = {
                headers: {
                    'Authorization': `Bearer ${apiToken}`,
                    'Content-Type': 'application/json'
                }
            };

            if (options.recordId) {
                url += `/${options.recordId}`;
            }

            if (options.method) {
                fetchOptions.method = options.method;
            }

            if (options.body) {
                fetchOptions.body = JSON.stringify(options.body);
            }

            if (options.offset) {
                url += `?offset=${options.offset}`;
            }

            if (options.filterByFormula) {
                const separator = url.includes('?') ? '&' : '?';
                url += `${separator}filterByFormula=${encodeURIComponent(options.filterByFormula)}`;
            }

            if (options.maxRecords) {
                const separator = url.includes('?') ? '&' : '?';
                url += `${separator}maxRecords=${options.maxRecords}`;
            }

            const response = await fetch(url, fetchOptions);
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API Error');
            }

            return response.json();
        }

        // ============================================
        // AUTH
        // ============================================
        function login() {
            const token = document.getElementById('api-token').value.trim();
            if (!token) {
                showToast('Inserisci il token API', 'error');
                return;
            }

            apiToken = token;
            localStorage.setItem('airtable_token', token);
            
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            
            loadAllRecords();
        }

        function checkAuth() {
            const savedToken = localStorage.getItem('airtable_token');
            if (savedToken) {
                apiToken = savedToken;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                loadAllRecords();
            }
        }

        // ============================================
        // DATA LOADING
        // ============================================
        async function loadAllRecords() {
            showLoading();
            
            try {
                allRecords = [];
                let offset = null;
                
                do {
                    const params = {
                        filterByFormula: "{Review_Status}='PENDING'"
                    };
                    if (offset) params.offset = offset;
                    
                    const data = await apiRequest(PHOTO_CANDIDATES_TABLE, params);
                    allRecords = allRecords.concat(data.records);
                    offset = data.offset;
                } while (offset);

                const skuSet = new Set(allRecords.map(r => r.fields.SKU));
                const allSKUs = Array.from(skuSet);
                
                pendingCount = allSKUs.length;
                totalBatches = Math.ceil(allSKUs.length / BATCH_SIZE);
                currentBatchIndex = 0;

                updateStatsUI();
                
                if (allSKUs.length === 0) {
                    showEmptyState();
                    return;
                }

                loadBatch(0);

            } catch (error) {
                showToast('Errore caricamento: ' + error.message, 'error');
            }
        }

        function loadBatch(batchIndex) {
            const skuSet = new Set(allRecords.filter(r => r.fields.Review_Status === 'PENDING').map(r => r.fields.SKU));
            const allSKUs = Array.from(skuSet);
            
            const start = batchIndex * BATCH_SIZE;
            const end = Math.min(start + BATCH_SIZE, allSKUs.length);
            
            batchSKUs = allSKUs.slice(start, end);
            currentBatchIndex = batchIndex;
            totalBatches = Math.ceil(allSKUs.length / BATCH_SIZE) || 1;
            currentSKUIndex = 0;
            batchDoneCount = 0;

            updateBatchNav();
            updateStatsUI();

            if (batchSKUs.length > 0) {
                loadSKU(batchSKUs[0]);
            } else {
                showEmptyState();
            }
        }

        function loadNextBatch() {
            if (currentBatchIndex < totalBatches - 1) {
                loadBatch(currentBatchIndex + 1);
            }
        }

        function loadPrevBatch() {
            if (currentBatchIndex > 0) {
                loadBatch(currentBatchIndex - 1);
            }
        }

        function updateBatchNav() {
            document.getElementById('prev-batch-btn').disabled = currentBatchIndex === 0;
            document.getElementById('next-batch-btn').disabled = currentBatchIndex >= totalBatches - 1;
            document.getElementById('batch-info').textContent = `${currentBatchIndex + 1}/${totalBatches || 1}`;
        }

        // ============================================
        // SKU HANDLING
        // ============================================
        function loadSKU(sku) {
            currentSKU = sku;
            currentPhotos = allRecords.filter(r => r.fields.SKU === sku && r.fields.Review_Status === 'PENDING');
            
            selectedFront = null;
            selectedBack = null;
            selectedFrontData = null;
            selectedBackData = null;
            photoRotations = {};
            lastHoveredPhotoId = null;
            resetFlags();

            document.getElementById('current-sku').textContent = sku;
            document.getElementById('batch-progress').textContent = `${currentSKUIndex + 1}/${batchSKUs.length}`;
            
            updateSelectionStatus();
            renderPhotos();
            updateConfirmButton();
        }

        function loadNextSKU() {
            currentSKUIndex++;
            batchDoneCount++;
            
            // Recalculate batchSKUs from remaining PENDING records
            const remainingSKUs = new Set(
                allRecords
                    .filter(r => r.fields.Review_Status === 'PENDING')
                    .map(r => r.fields.SKU)
            );
            
            // Find next SKU in current batch that's still pending
            let nextSKU = null;
            for (let i = currentSKUIndex; i < batchSKUs.length; i++) {
                if (remainingSKUs.has(batchSKUs[i])) {
                    nextSKU = batchSKUs[i];
                    currentSKUIndex = i;
                    break;
                }
            }
            
            if (nextSKU) {
                loadSKU(nextSKU);
            } else if (remainingSKUs.size > 0) {
                // Current batch exhausted but more SKUs exist
                showToast('Batch completato! Carico il prossimo...', 'success');
                setTimeout(() => {
                    // Rebuild batches from remaining SKUs
                    const allRemainingSKUs = Array.from(remainingSKUs);
                    totalBatches = Math.ceil(allRemainingSKUs.length / BATCH_SIZE) || 1;
                    currentBatchIndex = 0;
                    batchSKUs = allRemainingSKUs.slice(0, BATCH_SIZE);
                    currentSKUIndex = 0;
                    updateBatchNav();
                    loadSKU(batchSKUs[0]);
                }, 500);
            } else {
                showEmptyState();
                showToast('üéâ Tutti gli SKU completati!', 'success');
            }
            
            updateStatsUI();
        }

        // ============================================
        // RENDERING
        // ============================================
        function renderPhotos() {
            const grid = document.getElementById('photo-grid');
            
            if (currentPhotos.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="icon">üì∑</div>Nessuna foto per questo SKU</div>';
                return;
            }

            grid.innerHTML = currentPhotos.map((photo, index) => {
                const fileId = photo.fields.FileId;
                const filename = photo.fields.Filename || 'photo';
                const thumbnailUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w400`;
                const fullUrl = `https://drive.google.com/uc?export=view&id=${fileId}`;
                
                let cardClass = 'photo-card';
                let labelHtml = '';
                
                if (selectedFront === photo.id) {
                    cardClass += ' selected-front';
                    labelHtml = '<div class="photo-label front">FRONT</div>';
                } else if (selectedBack === photo.id) {
                    cardClass += ' selected-back';
                    labelHtml = '<div class="photo-label back">BACK</div>';
                }

                // Get rotation class
                const rotation = photoRotations[photo.id] || 0;
                let rotateClass = '';
                if (rotation === 90) rotateClass = 'rotate-90';
                else if (rotation === 180) rotateClass = 'rotate-180';
                else if (rotation === 270) rotateClass = 'rotate-270';

                return `
                    <div class="${cardClass}" data-id="${photo.id}" data-index="${index}" 
                         onclick="handlePhotoClick('${photo.id}', '${fileId}')" 
                         ondblclick="openModal('${fullUrl}')"
                         onmouseenter="lastHoveredPhotoId='${photo.id}'">
                        <div class="photo-container">
                            <img src="${thumbnailUrl}" alt="${filename}" loading="lazy" class="${rotateClass}">
                            ${labelHtml}
                            <button class="rotate-btn" onclick="event.stopPropagation(); rotatePhoto('${photo.id}')" title="Ruota 90¬∞">üîÑ</button>
                        </div>
                        <div class="photo-filename">${filename}</div>
                    </div>
                `;
            }).join('');
        }

        function rotatePhoto(photoId) {
            const currentRotation = photoRotations[photoId] || 0;
            photoRotations[photoId] = (currentRotation + 90) % 360;
            renderPhotos();
        }

        function showLoading() {
            document.getElementById('photo-grid').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Caricamento...
                </div>
            `;
        }

        function showEmptyState() {
            document.getElementById('photo-grid').innerHTML = `
                <div class="empty-state">
                    <div class="icon">‚úÖ</div>
                    <div>Nessun SKU in attesa di review</div>
                </div>
            `;
            document.getElementById('current-sku').textContent = '---';
            document.getElementById('batch-progress').textContent = '0/0';
        }

        // ============================================
        // SELECTION
        // ============================================
        function handlePhotoClick(recordId, fileId) {
            const photo = currentPhotos.find(p => p.id === recordId);
            if (!photo) return;

            if (!selectedFront) {
                selectedFront = recordId;
                selectedFrontData = { recordId, fileId };
            }
            else if (selectedFront === recordId) {
                selectedFront = null;
                selectedFrontData = null;
            }
            else if (!selectedBack) {
                selectedBack = recordId;
                selectedBackData = { recordId, fileId };
            }
            else if (selectedBack === recordId) {
                selectedBack = null;
                selectedBackData = null;
            }
            else if (selectedFront === recordId) {
                selectedFront = null;
                selectedFrontData = null;
            }
            else if (selectedBack === recordId) {
                selectedBack = null;
                selectedBackData = null;
            }

            renderPhotos();
            updateSelectionStatus();
            updateConfirmButton();
        }

        function selectAsFront() {
            const unselected = currentPhotos.find(p => p.id !== selectedFront && p.id !== selectedBack);
            if (unselected) {
                selectedFront = unselected.id;
                selectedFrontData = { recordId: unselected.id, fileId: unselected.fields.FileId };
                renderPhotos();
                updateSelectionStatus();
                updateConfirmButton();
            }
        }

        function selectAsBack() {
            const unselected = currentPhotos.find(p => p.id !== selectedFront && p.id !== selectedBack);
            if (unselected) {
                selectedBack = unselected.id;
                selectedBackData = { recordId: unselected.id, fileId: unselected.fields.FileId };
                renderPhotos();
                updateSelectionStatus();
                updateConfirmButton();
            }
        }

        function updateSelectionStatus() {
            const frontText = document.getElementById('front-status-text');
            const backText = document.getElementById('back-status-text');
            
            if (selectedFront) {
                frontText.textContent = '‚úì';
                frontText.className = 'status selected';
            } else {
                frontText.textContent = '‚Äî';
                frontText.className = 'status pending';
            }
            
            if (selectedBack) {
                backText.textContent = '‚úì';
                backText.className = 'status selected';
            } else {
                backText.textContent = '‚Äî';
                backText.className = 'status pending';
            }
        }

        function updateConfirmButton() {
            const btn = document.getElementById('confirm-btn');
            const hasFlags = Object.values(flags).some(v => v);
            const hasSelection = selectedFront && selectedBack;
            
            btn.disabled = !hasSelection && !hasFlags;
            
            const flagBtn = document.getElementById('flag-btn');
            if (hasFlags && !hasSelection) {
                flagBtn.style.display = 'block';
                btn.style.display = 'none';
            } else {
                flagBtn.style.display = 'none';
                btn.style.display = 'block';
            }
        }

        // ============================================
        // FLAGS
        // ============================================
        function toggleFlag(flagName) {
            flags[flagName] = !flags[flagName];
            
            const btnMap = {
                missingFront: 'flag-missing-front',
                missingBack: 'flag-missing-back',
                needsReshoot: 'flag-reshoot',
                maybeSold: 'flag-maybe-sold'
            };
            
            const btn = document.getElementById(btnMap[flagName]);
            btn.classList.toggle('active', flags[flagName]);
            
            updateConfirmButton();
        }

        function resetFlags() {
            flags = {
                missingFront: false,
                missingBack: false,
                needsReshoot: false,
                maybeSold: false
            };
            
            document.querySelectorAll('.flag-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById('flag-btn').style.display = 'none';
            document.getElementById('confirm-btn').style.display = 'block';
        }

        // ============================================
        // ACTIONS
        // ============================================
        async function confirmSelection() {
            const btn = document.getElementById('confirm-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Salvando...';

            try {
                if (selectedFront) {
                    await apiRequest(PHOTO_CANDIDATES_TABLE, {
                        recordId: selectedFront,
                        method: 'PATCH',
                        body: { fields: { Is_Front: true, Review_Status: 'ASSIGNED' } }
                    });
                }

                if (selectedBack) {
                    await apiRequest(PHOTO_CANDIDATES_TABLE, {
                        recordId: selectedBack,
                        method: 'PATCH',
                        body: { fields: { Is_Back: true, Review_Status: 'ASSIGNED' } }
                    });
                }

                for (const photo of currentPhotos) {
                    if (photo.id !== selectedFront && photo.id !== selectedBack) {
                        await apiRequest(PHOTO_CANDIDATES_TABLE, {
                            recordId: photo.id,
                            method: 'PATCH',
                            body: { fields: { Review_Status: 'ASSIGNED' } }
                        });
                    }
                }

                let oldInvRecord = null;
                let offset = null;
                do {
                    const data = await apiRequest(OLD_INVENTORY_TABLE, { offset });
                    oldInvRecord = data.records.find(r => r.fields.SKU === currentSKU);
                    if (oldInvRecord) break;
                    offset = data.offset;
                } while (offset);

                if (oldInvRecord) {
                    const updateFields = {
                        Confirmed_Front_FileId: selectedFrontData.fileId,
                        Confirmed_Back_FileId: selectedBackData.fileId,
                        Photo_Audit_Status: 'COMPLIANT',
                        Migration_AI_Mode: AI_MODE,
                        Migration_Platforms: DEFAULT_PLATFORMS,
                        Ready_To_Migrate: true
                    };

                    if (flags.missingFront) updateFields.Flag_Missing_Front = true;
                    if (flags.missingBack) updateFields.Flag_Missing_Back = true;
                    if (flags.needsReshoot) updateFields.Flag_Needs_Reshoot = true;
                    if (flags.maybeSold) updateFields.Flag_Maybe_Sold = true;
                    
                    if (Object.values(flags).some(v => v)) {
                        updateFields.QC_Flagged_Date = new Date().toISOString().split('T')[0];
                    }

                    await apiRequest(OLD_INVENTORY_TABLE, {
                        recordId: oldInvRecord.id,
                        method: 'PATCH',
                        body: { fields: updateFields }
                    });
                }

                // Update local state
                for (const photo of currentPhotos) {
                    const idx = allRecords.findIndex(r => r.id === photo.id);
                    if (idx !== -1) {
                        allRecords[idx].fields.Review_Status = 'ASSIGNED';
                    }
                }

                doneCount++;
                pendingCount--;
                updateStatsUI();
                
                showToast(`‚úì ${currentSKU} pronto per migrazione`, 'success');
                
                btn.textContent = '‚úì Conferma & Prossimo';
                btn.disabled = false;
                
                // Advance to next SKU
                loadNextSKU();

            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = '‚úì Conferma & Prossimo';
            }
        }

        async function submitWithFlags() {
            const btn = document.getElementById('flag-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Segnalando...';

            try {
                // Find OLD_INVENTORY record
                let oldInvRecord = null;
                let offset = null;
                do {
                    const data = await apiRequest(OLD_INVENTORY_TABLE, { offset });
                    oldInvRecord = data.records.find(r => r.fields.SKU === currentSKU);
                    if (oldInvRecord) break;
                    offset = data.offset;
                } while (offset);

                if (oldInvRecord) {
                    const updateFields = {
                        Photo_Audit_Status: 'FLAGGED',
                        QC_Flagged_Date: new Date().toISOString().split('T')[0]
                    };

                    if (flags.missingFront) updateFields.Flag_Missing_Front = true;
                    if (flags.missingBack) updateFields.Flag_Missing_Back = true;
                    if (flags.needsReshoot) updateFields.Flag_Needs_Reshoot = true;
                    if (flags.maybeSold) updateFields.Flag_Maybe_Sold = true;

                    await apiRequest(OLD_INVENTORY_TABLE, {
                        recordId: oldInvRecord.id,
                        method: 'PATCH',
                        body: { fields: updateFields }
                    });
                }

                // Mark photos as FLAGGED
                for (const photo of currentPhotos) {
                    await apiRequest(PHOTO_CANDIDATES_TABLE, {
                        recordId: photo.id,
                        method: 'PATCH',
                        body: { fields: { Review_Status: 'FLAGGED' } }
                    });
                    
                    // Update local state
                    const idx = allRecords.findIndex(r => r.id === photo.id);
                    if (idx !== -1) {
                        allRecords[idx].fields.Review_Status = 'FLAGGED';
                    }
                }

                pendingCount--;
                updateStatsUI();
                
                const flagNames = [];
                if (flags.missingFront) flagNames.push('No Front');
                if (flags.missingBack) flagNames.push('No Back');
                if (flags.needsReshoot) flagNames.push('Rifare');
                if (flags.maybeSold) flagNames.push('Venduto?');
                
                showToast(`‚ö†Ô∏è ${currentSKU} segnalato: ${flagNames.join(', ')}`, 'warning');
                
                btn.textContent = '‚ö†Ô∏è Segnala & Prossimo';
                btn.disabled = false;
                
                // FIXED: Advance to next SKU
                loadNextSKU();

            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = '‚ö†Ô∏è Segnala & Prossimo';
            }
        }

        async function skipSKU() {
            const btn = document.querySelector('.action-btn.skip');
            btn.textContent = '‚è≥ Skipping...';

            try {
                for (const photo of currentPhotos) {
                    await apiRequest(PHOTO_CANDIDATES_TABLE, {
                        recordId: photo.id,
                        method: 'PATCH',
                        body: { fields: { Review_Status: 'SKIPPED' } }
                    });
                    
                    const idx = allRecords.findIndex(r => r.id === photo.id);
                    if (idx !== -1) {
                        allRecords[idx].fields.Review_Status = 'SKIPPED';
                    }
                }

                pendingCount--;
                updateStatsUI();
                showToast(`‚è≠Ô∏è ${currentSKU} saltato`, 'error');
                btn.textContent = '‚è≠Ô∏è Salta SKU';
                loadNextSKU();

            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
                btn.textContent = '‚è≠Ô∏è Salta SKU';
            }
        }

        // ============================================
        // UI HELPERS
        // ============================================
        function updateStatsUI() {
            document.getElementById('pending-count').textContent = pendingCount;
            document.getElementById('done-count').textContent = doneCount;
            
            const total = pendingCount + doneCount;
            const percent = total > 0 ? (doneCount / total) * 100 : 0;
            document.getElementById('progress-fill').style.width = `${percent}%`;
        }

        function openModal(url) {
            document.getElementById('modal-img').src = url;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ============================================
        // KEYBOARD SHORTCUTS
        // ============================================
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;

            switch(e.key.toLowerCase()) {
                case 'f':
                    selectAsFront();
                    break;
                case 'b':
                    selectAsBack();
                    break;
                case 'r':
                    // Rotate last hovered photo, or first photo if none hovered
                    if (lastHoveredPhotoId) {
                        rotatePhoto(lastHoveredPhotoId);
                    } else if (currentPhotos.length > 0) {
                        rotatePhoto(currentPhotos[0].id);
                    }
                    break;
                case '1':
                    toggleFlag('missingFront');
                    break;
                case '2':
                    toggleFlag('missingBack');
                    break;
                case '3':
                    toggleFlag('needsReshoot');
                    break;
                case '4':
                    toggleFlag('maybeSold');
                    break;
                case 'enter':
                    e.preventDefault();
                    if (Object.values(flags).some(v => v) && !selectedFront && !selectedBack) {
                        submitWithFlags();
                    } else if (selectedFront && selectedBack) {
                        confirmSelection();
                    }
                    break;
                case 's':
                    skipSKU();
                    break;
                case 'escape':
                    closeModal();
                    break;
                case 'arrowright':
                    if (e.ctrlKey || e.metaKey) loadNextBatch();
                    break;
                case 'arrowleft':
                    if (e.ctrlKey || e.metaKey) loadPrevBatch();
                    break;
            }
        });

        // ============================================
        // INIT
        // ============================================
        checkAuth();
    </script>
</body>
</html>
