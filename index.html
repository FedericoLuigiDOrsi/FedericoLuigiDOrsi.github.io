<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõÉ Dogana Import ‚Äî DirtyTag Photo QC v8</title>
    <style>
        :root {
            --black: #0D0D0D;
            --black-soft: #1A1A1A;
            --black-card: #242424;
            --red: #C41E3A;
            --red-hover: #E63950;
            --red-muted: rgba(196, 30, 58, 0.15);
            --beige: #E8DFD0;
            --beige-muted: #C4B9A8;
            --white: #FAFAFA;
            --white-muted: #B0B0B0;
            --success: #2ECC71;
            --warning: #F39C12;
            --border: #333;
            --border-light: #444;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--black);
            color: var(--white);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* HEADER */
        .header {
            background: var(--black-soft);
            padding: 1rem 2rem;
            border-bottom: 3px solid var(--red);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .header-brand h1 {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--white);
            letter-spacing: -0.5px;
        }
        
        .header-brand .version {
            font-size: 0.7rem;
            background: var(--red);
            color: var(--white);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }

        /* STATS BAR */
        .stats-bar {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 1rem;
            background: var(--black);
            border-radius: 8px;
            min-width: 70px;
        }
        
        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--beige);
            font-variant-numeric: tabular-nums;
        }
        
        .stat-label {
            font-size: 0.7rem;
            color: var(--white-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat.success .stat-value { color: var(--success); }
        .stat.warning .stat-value { color: var(--warning); }
        .stat.pending .stat-value { color: var(--red); }

        /* BUTTONS */
        .btn-icon {
            background: var(--black);
            border: 1px solid var(--border);
            color: var(--white-muted);
            padding: 0.6rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .btn-icon:hover {
            border-color: var(--red);
            color: var(--red);
            background: var(--red-muted);
        }

        /* FILTERS */
        .filters-section {
            background: var(--black-soft);
            padding: 1rem 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: flex-end;
            border-bottom: 1px solid var(--border);
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }
        
        .filter-group label {
            font-size: 0.7rem;
            color: var(--white-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        
        .filter-group select {
            background: var(--black);
            border: 1px solid var(--border);
            color: var(--white);
            padding: 0.6rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            min-width: 150px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        
        .filter-group select:hover,
        .filter-group select:focus {
            border-color: var(--beige-muted);
            outline: none;
        }

        /* PAGINATION */
        .pagination {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: auto;
        }
        
        .pagination button {
            background: var(--black);
            border: 1px solid var(--border);
            color: var(--white);
            padding: 0.6rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .pagination button:hover:not(:disabled) {
            border-color: var(--red);
            background: var(--red-muted);
        }
        
        .pagination button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .page-info {
            padding: 0.6rem 1rem;
            background: var(--black-card);
            border-radius: 6px;
            font-size: 0.85rem;
            font-variant-numeric: tabular-nums;
            color: var(--beige);
            font-weight: 500;
        }

        /* TOKEN SECTION */
        .token-section {
            padding: 3rem 2rem;
            text-align: center;
            max-width: 450px;
            margin: 4rem auto;
            background: var(--black-card);
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        
        .token-section h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            color: var(--white);
        }
        
        .token-section p {
            color: var(--white-muted);
            margin-bottom: 1.5rem;
        }
        
        .token-section input {
            width: 100%;
            padding: 1rem;
            background: var(--black);
            border: 1px solid var(--border);
            color: var(--white);
            border-radius: 8px;
            margin-bottom: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
        }
        
        .token-section input:focus {
            outline: none;
            border-color: var(--red);
        }
        
        .token-section button {
            background: var(--red);
            border: none;
            color: var(--white);
            padding: 1rem 2.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .token-section button:hover {
            background: var(--red-hover);
        }

        /* MAIN CONTENT */
        .main-content {
            padding: 1.5rem 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* PRODUCT CARD */
        .product-card {
            background: var(--black-card);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }
        
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .product-sku {
            font-size: 1.6rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--beige);
            letter-spacing: 1px;
        }
        
        .product-meta {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .product-meta span {
            background: var(--black);
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--white-muted);
        }
        
        .product-meta span.warning {
            background: rgba(243, 156, 18, 0.15);
            color: var(--warning);
        }

        /* PHOTO GRID */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            border: 3px solid var(--border);
            transition: all 0.2s ease;
            background: var(--black);
        }
        
        .photo-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            border-color: var(--beige-muted);
        }
        
        .photo-item.selected-front {
            border-color: var(--success);
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.3);
        }
        
        .photo-item.selected-back {
            border-color: var(--warning);
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.3);
        }
        
        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-label {
            position: absolute;
            top: 8px;
            left: 8px;
            padding: 0.35rem 0.7rem;
            border-radius: 5px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .photo-label.front {
            background: var(--success);
            color: var(--black);
        }
        
        .photo-label.back {
            background: var(--warning);
            color: var(--black);
        }
        
        .photo-index {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--white-muted);
        }
        
        .photo-filename {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
            padding: 1.5rem 0.5rem 0.4rem;
            font-size: 0.65rem;
            text-align: center;
            color: var(--white-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* SELECTION CONTROLS */
        .selection-controls {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
            padding: 1rem;
            background: var(--black);
            border-radius: 8px;
        }
        
        .selection-info {
            display: flex;
            gap: 1rem;
            flex: 1;
        }
        
        .selection-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
        }
        
        .selection-badge.front {
            background: rgba(46, 204, 113, 0.15);
            color: var(--success);
            border: 1px solid var(--success);
        }
        
        .selection-badge.back {
            background: rgba(243, 156, 18, 0.15);
            color: var(--warning);
            border: 1px solid var(--warning);
        }
        
        .selection-badge.empty {
            background: var(--black-soft);
            color: var(--white-muted);
            border: 1px dashed var(--border);
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .control-group label {
            font-size: 0.8rem;
            color: var(--white-muted);
            font-weight: 500;
        }
        
        .control-group select {
            background: var(--black-card);
            border: 1px solid var(--border);
            color: var(--white);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
        }

        /* ACTION BUTTONS */
        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.9rem 1.8rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--success);
            color: var(--black);
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #27ae60;
            transform: translateY(-1px);
        }
        
        .btn-primary:disabled {
            background: var(--border);
            color: var(--white-muted);
            cursor: not-allowed;
        }
        
        .btn-danger {
            background: var(--red);
            color: var(--white);
        }
        
        .btn-danger:hover {
            background: var(--red-hover);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: var(--black);
            color: var(--white);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            border-color: var(--beige-muted);
            background: var(--black-soft);
        }

        /* KEYBOARD HINTS */
        .keyboard-hints {
            display: flex;
            gap: 1.2rem;
            font-size: 0.75rem;
            color: var(--white-muted);
            margin-top: 1rem;
            flex-wrap: wrap;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }
        
        .keyboard-hints span {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        .keyboard-hints kbd {
            background: var(--black);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            border: 1px solid var(--border);
            min-width: 24px;
            text-align: center;
        }

        /* MODALS */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--black-card);
            border-radius: 16px;
            padding: 2rem;
            max-width: 480px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        
        .modal h2 {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
            color: var(--white);
        }
        
        .modal-sku {
            color: var(--beige);
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .skip-reasons {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            margin-bottom: 1.5rem;
        }
        
        .skip-reason {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 1rem;
            background: var(--black);
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .skip-reason:hover {
            border-color: var(--border-light);
        }
        
        .skip-reason.selected {
            border-color: var(--red);
            background: var(--red-muted);
        }
        
        .skip-reason input[type="radio"] { display: none; }
        
        .skip-reason .radio-custom {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        
        .skip-reason.selected .radio-custom {
            border-color: var(--red);
        }
        
        .skip-reason.selected .radio-custom::after {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--red);
            border-radius: 50%;
        }
        
        .skip-reason span:last-child {
            font-size: 0.9rem;
        }
        
        .skip-notes {
            width: 100%;
            min-height: 80px;
            background: var(--black);
            border: 1px solid var(--border);
            color: var(--white);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            resize: vertical;
            font-family: inherit;
            font-size: 0.9rem;
        }
        
        .skip-notes:focus {
            outline: none;
            border-color: var(--red);
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        /* ZOOM MODAL */
        .zoom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.97);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            cursor: zoom-out;
        }
        
        .zoom-modal.active { display: flex; }
        
        .zoom-modal img {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
            border-radius: 4px;
        }

        /* STATES */
        .loading {
            text-align: center;
            padding: 4rem;
            color: var(--white-muted);
        }
        
        .spinner {
            width: 44px;
            height: 44px;
            border: 3px solid var(--border);
            border-top-color: var(--red);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .empty-state {
            text-align: center;
            padding: 4rem;
            color: var(--white-muted);
        }
        
        .empty-state h3 {
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
            color: var(--white);
        }
        
        .empty-state p {
            color: var(--white-muted);
        }

        /* TOAST */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--black-card);
            padding: 1rem 1.5rem;
            border-radius: 10px;
            border-left: 4px solid var(--success);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            z-index: 1002;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .toast.show { transform: translateX(0); }
        .toast.error { border-left-color: var(--red); }
        .toast.warning { border-left-color: var(--warning); }

        /* DEBUG PANEL */
        .debug-panel {
            background: var(--black);
            border: 1px solid var(--red);
            border-radius: 8px;
            padding: 1rem;
            margin: 0 2rem 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            max-height: 120px;
            overflow-y: auto;
            color: var(--white-muted);
        }
        
        .debug-panel.hidden { display: none; }
        
        .debug-panel div {
            padding: 0.2rem 0;
            border-bottom: 1px solid var(--border);
        }

        /* NO PHOTOS WARNING */
        .no-photos-warning {
            text-align: center;
            padding: 3rem;
            background: var(--black);
            border-radius: 8px;
            color: var(--warning);
        }
        
        .no-photos-warning p {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: var(--white-muted);
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .header { padding: 1rem; }
            .stats-bar { gap: 0.8rem; }
            .stat { padding: 0.4rem 0.6rem; min-width: 55px; }
            .stat-value { font-size: 1.1rem; }
            .filters-section { padding: 1rem; }
            .main-content { padding: 1rem; }
            .photo-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
        }
    </style>
</head>
<body>
    <div id="tokenSection" class="token-section">
        <h1>üõÉ Dogana Import</h1>
        <p>Inserisci il tuo Airtable Personal Access Token</p>
        <input type="password" id="tokenInput" placeholder="pat_xxxxxxxxxxxxx">
        <button onclick="saveToken()">Accedi</button>
    </div>

    <div id="mainApp" style="display: none;">
        <header class="header">
            <div class="header-brand">
                <h1>üõÉ Dogana Import</h1>
                <span class="version">v8</span>
            </div>
            <div class="stats-bar">
                <div class="stat pending">
                    <span class="stat-value" id="statPending">-</span>
                    <span class="stat-label">Da Fare</span>
                </div>
                <div class="stat success">
                    <span class="stat-value" id="statDone">-</span>
                    <span class="stat-label">Fatti</span>
                </div>
                <div class="stat warning">
                    <span class="stat-value" id="statSkipped">-</span>
                    <span class="stat-label">Scartati</span>
                </div>
                <div class="stat">
                    <span class="stat-value" id="statTotal">-</span>
                    <span class="stat-label">Totale</span>
                </div>
                <button class="btn-icon" onclick="resetToken()" title="Cambia Token">üîë</button>
                <button class="btn-icon" onclick="toggleDebug()" title="Debug">üêõ</button>
            </div>
        </header>

        <div class="filters-section">
            <div class="filter-group">
                <label>Categoria</label>
                <select id="filterCategory"><option value="">Tutte</option></select>
            </div>
            <div class="filter-group">
                <label>Brand</label>
                <select id="filterBrand"><option value="">Tutti</option></select>
            </div>
            <div class="filter-group">
                <label>Stato</label>
                <select id="filterStatus">
                    <option value="NEEDS_REVIEW">Da Revisionare</option>
                    <option value="">Tutti</option>
                    <option value="COMPLIANT">Compliant</option>
                    <option value="SKIPPED">Scartati</option>
                </select>
            </div>
            <button class="btn btn-secondary" onclick="applyFilters()">üîç Filtra</button>
            <div class="pagination">
                <button id="btnPrev" onclick="prevRecord()" disabled>‚óÄ</button>
                <span class="page-info" id="pageInfo">0 / 0</span>
                <button id="btnNext" onclick="nextRecord()">‚ñ∂</button>
                <button class="btn btn-secondary" onclick="loadData()" title="Ricarica">üîÑ</button>
            </div>
        </div>

        <div class="debug-panel hidden" id="debugPanel"></div>
        
        <main class="main-content">
            <div id="loadingState" class="loading">
                <div class="spinner"></div>
                <p>Caricamento...</p>
            </div>
            <div id="emptyState" class="empty-state" style="display:none;">
                <h3>üì≠ Nessun prodotto</h3>
                <p>Cambia i filtri o verifica i dati in Airtable</p>
            </div>
            <div id="productContainer"></div>
        </main>
    </div>

    <!-- SKIP MODAL -->
    <div class="modal-overlay" id="skipModal">
        <div class="modal">
            <h2>‚ùå Scarta Prodotto</h2>
            <p class="modal-sku">SKU: <strong id="skipModalSku"></strong></p>
            <div class="skip-reasons">
                <label class="skip-reason" onclick="selectSkipReason(this,'TOO_FEW_PHOTOS')">
                    <input type="radio" name="skipReason">
                    <span class="radio-custom"></span>
                    <span>üì∑ Troppe poche foto</span>
                </label>
                <label class="skip-reason" onclick="selectSkipReason(this,'NO_INTERNAL_LABELS')">
                    <input type="radio" name="skipReason">
                    <span class="radio-custom"></span>
                    <span>üè∑Ô∏è No etichette interne</span>
                </label>
                <label class="skip-reason" onclick="selectSkipReason(this,'LOW_QUALITY_PHOTOS')">
                    <input type="radio" name="skipReason">
                    <span class="radio-custom"></span>
                    <span>üì∏ Foto bassa qualit√†</span>
                </label>
                <label class="skip-reason" onclick="selectSkipReason(this,'MISSING_FRONT_BACK')">
                    <input type="radio" name="skipReason">
                    <span class="radio-custom"></span>
                    <span>üîÑ Front/Back mancante</span>
                </label>
                <label class="skip-reason" onclick="selectSkipReason(this,'OTHER')">
                    <input type="radio" name="skipReason">
                    <span class="radio-custom"></span>
                    <span>üìù Altro</span>
                </label>
            </div>
            <textarea class="skip-notes" id="skipNotes" placeholder="Note aggiuntive (opzionale)..."></textarea>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeSkipModal()">Annulla</button>
                <button class="btn btn-danger" id="confirmSkipBtn" onclick="confirmSkip()" disabled>Conferma</button>
            </div>
        </div>
    </div>

    <!-- ZOOM MODAL -->
    <div class="zoom-modal" id="zoomModal" onclick="closeZoomModal()">
        <img id="zoomImage" src="">
    </div>
    
    <!-- TOAST -->
    <div class="toast" id="toast"></div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CONFIG
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const BASE_ID = 'apptPbWnDkDkKEpFV';
        const RAW_INVENTORY_TABLE = 'tblddAcLcQAyk050u';
        const PHOTO_CANDIDATES_TABLE = 'tbl7ogfLnHsVfFdzb';

        // Field Names
        const F = {
            SKU: 'SKU',
            CATEGORY: 'Category',
            CATEGORY_NAME: 'Category Name (from Category)',
            BRAND: 'BRANDS',
            BRAND_NAME: 'Brand Name (from BRANDS)',
            PHOTO_AUDIT_STATUS: 'Photo_Audit_Status',
            PHOTO_COUNT: 'Photo_Count',
            CONFIRMED_FRONT: 'Confirmed_Front_FileId',
            CONFIRMED_BACK: 'Confirmed_Back_FileId',
            MIGRATION_AI_MODE: 'Migration_AI_Mode',
            MIGRATION_TEMPLATE: 'Migration_Template',
            MIGRATION_STATUS: 'Migration_Status',
            READY_TO_MIGRATE: 'Ready_To_Migrate',
            SKIP_REASON: 'Skip_Reason',
            SKIP_NOTES: 'Skip_Notes',
            SKIPPED_AT: 'Skipped_At',
            REQUIRES_RESHOOT: 'Requires_Reshoot',
            BLOCKER_REASON: 'Blocker_Reason'
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // STATE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let token = localStorage.getItem('airtable_token') || '';
        let allRecords = [];  // FIX: Store all records for accurate stats
        let records = [];     // Filtered records for display
        let idx = 0;
        let currentSKU = null;
        let currentRecordId = null;
        let photos = [];
        let selFront = null;
        let selBack = null;
        let skipReason = null;
        let hoveredPhoto = null;
        let debugMode = false;
        let isProcessing = false;  // FIX: Prevent race conditions

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INIT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        document.addEventListener('DOMContentLoaded', () => {
            if (token) {
                showMain();
                loadData();
            } else {
                showToken();
            }
            document.addEventListener('keydown', handleKey);
        });

        function saveToken() {
            const t = document.getElementById('tokenInput').value.trim();
            if (!t) {
                toast('Inserisci token', 'error');
                return;
            }
            token = t;
            localStorage.setItem('airtable_token', token);
            showMain();
            loadData();
        }

        function resetToken() {
            localStorage.removeItem('airtable_token');
            token = '';
            showToken();
        }

        function showMain() {
            document.getElementById('tokenSection').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        }

        function showToken() {
            document.getElementById('tokenSection').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
        }

        function toggleDebug() {
            debugMode = !debugMode;
            document.getElementById('debugPanel').classList.toggle('hidden', !debugMode);
        }

        function log(m) {
            console.log(m);
            const p = document.getElementById('debugPanel');
            if (p) {
                const ts = new Date().toLocaleTimeString();
                p.innerHTML += `<div>[${ts}] ${m}</div>`;
                p.scrollTop = p.scrollHeight;
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DATA LOADING - FIX: Pagination support
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function loadData() {
            showLoading(true);
            document.getElementById('debugPanel').innerHTML = '';
            
            try {
                const status = document.getElementById('filterStatus')?.value || 'NEEDS_REVIEW';
                
                // Build filter
                let formula = `AND({${F.PHOTO_COUNT}}>0`;
                if (status) formula += `,{${F.PHOTO_AUDIT_STATUS}}='${status}'`;
                formula += ')';
                
                log(`üîç Filter: ${formula}`);
                
                // FIX: Load all pages
                allRecords = await fetchAllRecords(formula);
                log(`‚úÖ Loaded ${allRecords.length} total records`);
                
                // Apply client filters
                records = [...allRecords];
                const catFilter = document.getElementById('filterCategory')?.value;
                const brandFilter = document.getElementById('filterBrand')?.value;
                
                if (catFilter || brandFilter) {
                    records = records.filter(r => {
                        const cat = extractField(r, F.CATEGORY_NAME) || extractField(r, F.CATEGORY) || '';
                        const brand = extractField(r, F.BRAND_NAME) || extractField(r, F.BRAND) || '';
                        return (!catFilter || cat.includes(catFilter)) && 
                               (!brandFilter || brand.includes(brandFilter));
                    });
                    log(`üìã After filters: ${records.length} records`);
                }
                
                // Populate filter dropdowns
                const cats = new Set(), brands = new Set();
                allRecords.forEach(r => {
                    const c = extractField(r, F.CATEGORY_NAME) || extractField(r, F.CATEGORY);
                    const b = extractField(r, F.BRAND_NAME) || extractField(r, F.BRAND);
                    if (c) cats.add(c);
                    if (b) brands.add(b);
                });
                populateSelect('filterCategory', cats);
                populateSelect('filterBrand', brands);
                
                updateStats();
                idx = 0;
                
                if (records.length > 0) {
                    await showRecord();
                } else {
                    showEmpty();
                }
                
            } catch (e) {
                log(`‚ùå ${e.message}`);
                showError(e.message);
            }
            showLoading(false);
        }

        // FIX: Fetch all pages from Airtable
        async function fetchAllRecords(formula) {
            let all = [];
            let offset = null;
            
            do {
                let url = `https://api.airtable.com/v0/${BASE_ID}/${RAW_INVENTORY_TABLE}?pageSize=100`;
                url += `&filterByFormula=${encodeURIComponent(formula)}`;
                if (offset) url += `&offset=${offset}`;
                
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(`${res.status}: ${err.error?.message || 'Error'}`);
                }
                
                const data = await res.json();
                all = all.concat(data.records || []);
                offset = data.offset;
                
                if (offset) log(`üìÑ Loaded page, offset: ${offset.substring(0,10)}...`);
                
            } while (offset);
            
            return all;
        }

        // Helper to extract field value (handles arrays from linked records)
        function extractField(record, fieldName) {
            const val = record.fields[fieldName];
            if (Array.isArray(val)) return val[0];
            return val;
        }

        function populateSelect(id, values) {
            const sel = document.getElementById(id);
            const cur = sel.value;
            while (sel.options.length > 1) sel.remove(1);
            [...values].sort().forEach(v => {
                const o = document.createElement('option');
                o.value = v;
                o.textContent = v;
                sel.appendChild(o);
            });
            if ([...values].includes(cur)) sel.value = cur;
        }

        function applyFilters() {
            idx = 0;
            loadData();
        }

        function prevRecord() {
            if (idx > 0 && !isProcessing) {
                idx--;
                showRecord();
            }
        }

        function nextRecord() {
            if (idx < records.length - 1 && !isProcessing) {
                idx++;
                showRecord();
            }
        }

        // FIX: More accurate stats
        function updateStats() {
            const pending = allRecords.filter(r => r.fields[F.PHOTO_AUDIT_STATUS] === 'NEEDS_REVIEW').length;
            const done = allRecords.filter(r => r.fields[F.PHOTO_AUDIT_STATUS] === 'COMPLIANT').length;
            const skipped = allRecords.filter(r => r.fields[F.PHOTO_AUDIT_STATUS] === 'SKIPPED').length;
            
            document.getElementById('statTotal').textContent = allRecords.length;
            document.getElementById('statPending').textContent = pending;
            document.getElementById('statDone').textContent = done;
            document.getElementById('statSkipped').textContent = skipped;
            document.getElementById('pageInfo').textContent = records.length 
                ? `${idx + 1} / ${records.length}` 
                : '0 / 0';
            document.getElementById('btnPrev').disabled = idx <= 0;
            document.getElementById('btnNext').disabled = idx >= records.length - 1;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // RECORD DISPLAY
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function showRecord() {
            if (!records.length) {
                showEmpty();
                return;
            }
            
            const r = records[idx];
            currentRecordId = r.id;
            currentSKU = r.fields[F.SKU];
            
            log(`üì¶ Loading: ${currentSKU}`);
            updateStats();
            
            // Show loading state in card
            const container = document.getElementById('productContainer');
            container.innerHTML = `
                <div class="product-card">
                    <div class="product-header">
                        <span class="product-sku">${currentSKU}</span>
                    </div>
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Caricamento foto...</p>
                    </div>
                </div>`;
            
            await loadPhotos(currentSKU, r);
        }

        async function loadPhotos(sku, invRecord) {
            try {
                const url = `https://api.airtable.com/v0/${BASE_ID}/${PHOTO_CANDIDATES_TABLE}?filterByFormula=${encodeURIComponent(`{SKU}='${sku}'`)}`;
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                photos = data.records || [];
                log(`üì∑ ${photos.length} photos for ${sku}`);
                
                // Reset selections and check for pre-existing flags
                selFront = null;
                selBack = null;
                hoveredPhoto = null;  // FIX: Reset hovered photo
                
                photos.forEach(p => {
                    if (p.fields.Is_Front) selFront = p.id;
                    if (p.fields.Is_Back) selBack = p.id;
                });
                
                renderCard(invRecord);
                
            } catch (e) {
                log(`‚ùå Photos error: ${e.message}`);
                toast('Errore caricamento foto', 'error');
            }
        }

        function renderCard(r) {
            const sku = r.fields[F.SKU];
            const cat = extractField(r, F.CATEGORY_NAME) || extractField(r, F.CATEGORY) || 'N/A';
            const brand = extractField(r, F.BRAND_NAME) || extractField(r, F.BRAND) || 'N/A';
            const count = r.fields[F.PHOTO_COUNT] || 0;
            const blocker = r.fields[F.BLOCKER_REASON] || '';
            
            let photoHtml = '';
            if (!photos.length) {
                photoHtml = `
                    <div class="no-photos-warning">
                        <span style="font-size:2rem">‚ö†Ô∏è</span>
                        <p>Nessuna foto in PHOTO_CANDIDATES</p>
                        <p>Photo_Count dichiarato: ${count}</p>
                    </div>`;
            } else {
                photoHtml = photos.map((p, i) => {
                    const fid = p.fields.FileId;
                    const fn = p.fields.Filename || 'photo';
                    const thumb = `https://drive.google.com/thumbnail?id=${fid}&sz=w400`;
                    const full = `https://drive.google.com/uc?id=${fid}`;
                    
                    let label = '', cls = '';
                    if (p.id === selFront) {
                        label = '<span class="photo-label front">FRONT</span>';
                        cls = 'selected-front';
                    } else if (p.id === selBack) {
                        label = '<span class="photo-label back">BACK</span>';
                        cls = 'selected-back';
                    }
                    
                    return `
                        <div class="photo-item ${cls}" 
                             data-id="${p.id}" 
                             onclick="clickPhoto('${p.id}')" 
                             onmouseenter="hoveredPhoto='${p.id}'" 
                             onmouseleave="hoveredPhoto=null" 
                             ondblclick="openZoom('${full}')">
                            ${label}
                            <span class="photo-index">${i + 1}</span>
                            <img src="${thumb}" onerror="this.style.background='var(--black)'">
                            <span class="photo-filename">${fn}</span>
                        </div>`;
                }).join('');
            }
            
            // Selection badges
            const frontBadge = selFront 
                ? `<div class="selection-badge front">‚úì FRONT</div>`
                : `<div class="selection-badge empty">‚Äî Front</div>`;
            const backBadge = selBack
                ? `<div class="selection-badge back">‚úì BACK</div>`
                : `<div class="selection-badge empty">‚Äî Back</div>`;
            
            document.getElementById('productContainer').innerHTML = `
                <div class="product-card">
                    <div class="product-header">
                        <span class="product-sku">${sku}</span>
                        <div class="product-meta">
                            <span>üìÅ ${cat}</span>
                            <span>üè∑Ô∏è ${brand}</span>
                            <span>üì∑ ${photos.length}</span>
                            ${blocker ? `<span class="warning">‚ö†Ô∏è ${blocker}</span>` : ''}
                        </div>
                    </div>
                    
                    <div class="photo-grid">${photoHtml}</div>
                    
                    <div class="selection-controls">
                        <div class="selection-info">
                            ${frontBadge}
                            ${backBadge}
                        </div>
                        <div class="control-group">
                            <label>AI Mode:</label>
                            <select id="aiMode">
                                <option value="MANI">MANI</option>
                                <option value="FLAT">FLAT</option>
                                <option value="WORN">WORN</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="confirmBtn" onclick="confirmApprove()" ${!photos.length ? 'disabled' : ''}>
                            ‚úÖ Approva
                        </button>
                        <button class="btn btn-danger" onclick="openSkipModal()">
                            ‚ùå Scarta
                        </button>
                        <button class="btn btn-secondary" onclick="skipNext()">
                            ‚è≠Ô∏è Salta
                        </button>
                    </div>
                    
                    <div class="keyboard-hints">
                        <span><kbd>F</kbd> Front</span>
                        <span><kbd>B</kbd> Back</span>
                        <span><kbd>Enter</kbd> Approva</span>
                        <span><kbd>S</kbd> Scarta</span>
                        <span><kbd>N</kbd> Salta</span>
                        <span><kbd>Esc</kbd> Chiudi</span>
                    </div>
                </div>`;
            
            updateConfirmBtn();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHOTO SELECTION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function clickPhoto(id) {
            if (isProcessing) return;
            
            // FIX: Validate id exists in photos
            if (!photos.find(p => p.id === id)) {
                log(`‚ö†Ô∏è Invalid photo ID: ${id}`);
                return;
            }
            
            if (!selFront) {
                setFront(id);
            } else if (!selBack && id !== selFront) {
                setBack(id);
            } else if (id === selFront) {
                selFront = null;
                rerender();
                toast('Front deselezionato', 'warning');
            } else if (id === selBack) {
                selBack = null;
                rerender();
                toast('Back deselezionato', 'warning');
            } else {
                // Replace front
                setFront(id);
            }
        }

        function setFront(id) {
            // FIX: Prevent same photo for both
            if (id === selBack) selBack = null;
            selFront = id;
            rerender();
            toast('üì∑ FRONT selezionato', 'success');
        }

        function setBack(id) {
            // FIX: Prevent same photo for both
            if (id === selFront) selFront = null;
            selBack = id;
            rerender();
            toast('üì∑ BACK selezionato', 'success');
        }

        function rerender() {
            document.querySelectorAll('.photo-item').forEach(el => {
                const id = el.dataset.id;
                el.classList.remove('selected-front', 'selected-back');
                el.querySelector('.photo-label')?.remove();
                
                if (id === selFront) {
                    el.classList.add('selected-front');
                    el.insertAdjacentHTML('afterbegin', '<span class="photo-label front">FRONT</span>');
                } else if (id === selBack) {
                    el.classList.add('selected-back');
                    el.insertAdjacentHTML('afterbegin', '<span class="photo-label back">BACK</span>');
                }
            });
            
            // Update selection badges
            const infoDiv = document.querySelector('.selection-info');
            if (infoDiv) {
                const frontBadge = selFront 
                    ? `<div class="selection-badge front">‚úì FRONT</div>`
                    : `<div class="selection-badge empty">‚Äî Front</div>`;
                const backBadge = selBack
                    ? `<div class="selection-badge back">‚úì BACK</div>`
                    : `<div class="selection-badge empty">‚Äî Back</div>`;
                infoDiv.innerHTML = frontBadge + backBadge;
            }
            
            updateConfirmBtn();
        }

        function updateConfirmBtn() {
            const btn = document.getElementById('confirmBtn');
            if (btn) {
                btn.disabled = !(selFront && selBack);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CONFIRM APPROVE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function confirmApprove() {
            if (!selFront || !selBack || isProcessing) return;
            
            // FIX: Validate selections exist
            const front = photos.find(p => p.id === selFront);
            const back = photos.find(p => p.id === selBack);
            
            if (!front || !back) {
                toast('Errore: selezione non valida', 'error');
                log(`‚ùå Invalid selection - front: ${!!front}, back: ${!!back}`);
                return;
            }
            
            isProcessing = true;
            const btn = document.getElementById('confirmBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ Salvataggio...';
            
            try {
                const mode = document.getElementById('aiMode').value;
                
                log(`üíæ Saving ${currentSKU}: front=${front.fields.FileId}, back=${back.fields.FileId}, mode=${mode}`);
                
                // Update PHOTO_CANDIDATES
                // FIX: Checkbox fields need 1 (integer) not true (boolean)
                await update(PHOTO_CANDIDATES_TABLE, selFront, { Is_Front: 1, Review_Status: 'ASSIGNED' });
                await update(PHOTO_CANDIDATES_TABLE, selBack, { Is_Back: 1, Review_Status: 'ASSIGNED' });
                
                // Mark other photos as assigned
                for (const p of photos) {
                    if (p.id !== selFront && p.id !== selBack) {
                        await update(PHOTO_CANDIDATES_TABLE, p.id, { Review_Status: 'ASSIGNED' });
                    }
                }
                
                // Update RAW_INVENTORY
                // FIX: Checkbox fields need 1 (integer) not true (boolean)
                await update(RAW_INVENTORY_TABLE, currentRecordId, {
                    [F.CONFIRMED_FRONT]: front.fields.FileId,
                    [F.CONFIRMED_BACK]: back.fields.FileId,
                    [F.PHOTO_AUDIT_STATUS]: 'COMPLIANT',
                    [F.MIGRATION_AI_MODE]: mode,
                    [F.READY_TO_MIGRATE]: 1          // Checkbox: 1 = checked
                });
                
                toast(`‚úÖ ${currentSKU} approvato`, 'success');
                log(`‚úÖ ${currentSKU} saved successfully`);
                
                // Remove from local array and advance
                records.splice(idx, 1);
                // Also update allRecords for accurate stats
                const allIdx = allRecords.findIndex(r => r.id === currentRecordId);
                if (allIdx >= 0) allRecords.splice(allIdx, 1);
                
                if (idx >= records.length) idx = Math.max(0, records.length - 1);
                
                if (records.length) {
                    await showRecord();
                } else {
                    showEmpty();
                }
                updateStats();
                
            } catch (e) {
                log(`‚ùå Save error: ${e.message}`);
                toast('Errore salvataggio', 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            } finally {
                isProcessing = false;
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SKIP MODAL
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function openSkipModal() {
            if (isProcessing) return;
            document.getElementById('skipModalSku').textContent = currentSKU;
            document.getElementById('skipModal').classList.add('active');
            skipReason = null;
            document.querySelectorAll('.skip-reason').forEach(el => el.classList.remove('selected'));
            document.getElementById('skipNotes').value = '';
            document.getElementById('confirmSkipBtn').disabled = true;
        }

        function closeSkipModal() {
            document.getElementById('skipModal').classList.remove('active');
        }

        function selectSkipReason(el, reason) {
            document.querySelectorAll('.skip-reason').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            skipReason = reason;
            document.getElementById('confirmSkipBtn').disabled = false;
        }

        async function confirmSkip() {
            if (!skipReason || isProcessing) return;
            
            isProcessing = true;
            const btn = document.getElementById('confirmSkipBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥...';
            
            try {
                const notes = document.getElementById('skipNotes').value.trim();
                
                log(`üóëÔ∏è Skipping ${currentSKU}: reason=${skipReason}`);
                
                // Delete photos from PHOTO_CANDIDATES
                for (const p of photos) {
                    await del(PHOTO_CANDIDATES_TABLE, p.id);
                }
                
                // Update RAW_INVENTORY with reset
                // FIX: Single Select fields need '' (empty string) not null
                // FIX: Checkbox fields need 0/1 (integer) not true/false (boolean)
                await update(RAW_INVENTORY_TABLE, currentRecordId, {
                    [F.CONFIRMED_FRONT]: '',
                    [F.CONFIRMED_BACK]: '',
                    [F.PHOTO_AUDIT_STATUS]: 'SKIPPED',
                    [F.MIGRATION_AI_MODE]: '',       // Single Select: stringa vuota per reset
                    [F.READY_TO_MIGRATE]: 0,         // Checkbox: 0 = unchecked
                    [F.SKIP_REASON]: skipReason,
                    [F.SKIP_NOTES]: notes,
                    [F.SKIPPED_AT]: new Date().toISOString(),
                    [F.REQUIRES_RESHOOT]: 1          // Checkbox: 1 = checked
                });
                
                closeSkipModal();
                toast(`‚ùå ${currentSKU} scartato`, 'warning');
                log(`‚úÖ ${currentSKU} skipped`);
                
                // Remove from arrays
                records.splice(idx, 1);
                const allIdx = allRecords.findIndex(r => r.id === currentRecordId);
                if (allIdx >= 0) allRecords.splice(allIdx, 1);
                
                if (idx >= records.length) idx = Math.max(0, records.length - 1);
                
                if (records.length) {
                    await showRecord();
                } else {
                    showEmpty();
                }
                updateStats();
                
            } catch (e) {
                log(`‚ùå Skip error: ${e.message}`);
                toast('Errore durante skip', 'error');
                btn.disabled = false;
                btn.textContent = 'Conferma';
            } finally {
                isProcessing = false;
            }
        }

        function skipNext() {
            if (isProcessing) return;
            if (idx < records.length - 1) {
                idx++;
            } else if (records.length > 1) {
                idx = 0;
            }
            showRecord();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // API HELPERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function update(table, id, fields) {
            const res = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${table}/${id}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ fields })
            });
            
            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.error?.message || 'Update failed');
            }
            return res.json();
        }

        async function del(table, id) {
            const res = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${table}/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.error?.message || 'Delete failed');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // KEYBOARD SHORTCUTS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function handleKey(e) {
            // Ignore if typing in input/textarea
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            if (isProcessing) return;
            
            switch (e.key.toLowerCase()) {
                case 'f':
                    if (hoveredPhoto) setFront(hoveredPhoto);
                    break;
                case 'b':
                    if (hoveredPhoto) setBack(hoveredPhoto);
                    break;
                case 'enter':
                    if (selFront && selBack) confirmApprove();
                    break;
                case 's':
                    openSkipModal();
                    break;
                case 'n':
                    skipNext();
                    break;
                case 'escape':
                    closeSkipModal();
                    closeZoomModal();
                    break;
                case 'arrowleft':
                    prevRecord();
                    break;
                case 'arrowright':
                    nextRecord();
                    break;
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // UI HELPERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function openZoom(url) {
            document.getElementById('zoomImage').src = url;
            document.getElementById('zoomModal').classList.add('active');
        }

        function closeZoomModal() {
            document.getElementById('zoomModal').classList.remove('active');
        }

        function showLoading(show) {
            document.getElementById('loadingState').style.display = show ? 'block' : 'none';
            document.getElementById('emptyState').style.display = 'none';
            if (show) document.getElementById('productContainer').innerHTML = '';
        }

        function showEmpty() {
            document.getElementById('productContainer').innerHTML = '';
            document.getElementById('emptyState').style.display = 'block';
        }

        function showError(msg) {
            document.getElementById('productContainer').innerHTML = `
                <div class="product-card" style="border-left: 4px solid var(--red)">
                    <h3 style="color: var(--red); margin-bottom: 0.5rem;">‚ùå Errore</h3>
                    <p style="color: var(--white-muted); margin-bottom: 1rem;">${msg}</p>
                    <button class="btn btn-secondary" onclick="resetToken()">üîë Cambia Token</button>
                </div>`;
        }

        function toast(msg, type = 'success') {
            const el = document.getElementById('toast');
            el.textContent = msg;
            el.className = 'toast ' + type + ' show';
            setTimeout(() => el.classList.remove('show'), 2500);
        }
    </script>
</body>
</html>
